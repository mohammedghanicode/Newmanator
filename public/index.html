<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newmanator - Newman Report Collation Tool</title>
    <style>
        /* Design System CSS */
        :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;

  /* RGB versions for opacity control */
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
    Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
    0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
    0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Force light mode - disable dark mode */

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
    format('woff2');
}

/* Base styles */
html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: #1f2937;
  background-color: #f3f4f6;
  -webkit-font-smoothing: antialiased;
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 0;
}

*,
*::before,
*::after {
  box-sizing: inherit;
}

/* Custom Styles */
.app-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

.header {
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
    border-bottom: none;
    padding: var(--space-20) var(--space-32);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.header-content {
    max-width: var(--container-xl);
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: var(--space-16);
}

.logo {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: var(--space-12);
}

.logo-icon {
    font-size: 32px;
}

.main-content {
    flex: 1;
    padding: var(--space-32);
    max-width: var(--container-xl);
    margin: 0 auto;
    width: 100%;
}

.hero-section {
    text-align: center;
    margin-bottom: var(--space-32);
}

.hero-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    margin-bottom: var(--space-16);
    color: #1f2937;
}

.hero-description {
    font-size: var(--font-size-lg);
    color: #6b7280;
    max-width: 700px;
    margin: 0 auto var(--space-32);
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-16);
    margin-bottom: var(--space-32);
}

.feature-card {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-lg);
    padding: var(--space-20);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
}

.feature-card h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-8);
    color: #1f2937;
}

.feature-card p {
    font-size: var(--font-size-base);
    color: #6b7280;
    margin: 0;
}

.upload-section {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-lg);
    padding: var(--space-32);
    margin-bottom: var(--space-24);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.drop-zone {
    border: 2px dashed #d1d5db;
    border-radius: var(--radius-lg);
    padding: var(--space-32);
    text-align: center;
    background-color: #f9fafb;
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
}

.drop-zone:hover {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

.drop-zone.drag-over {
    border-color: #3b82f6;
    background-color: #dbeafe;
    border-style: solid;
}

.drop-zone-icon {
    font-size: 48px;
    margin-bottom: var(--space-16);
}

.drop-zone-text {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-medium);
    color: #1f2937;
    margin-bottom: var(--space-8);
}

.drop-zone-subtext {
    font-size: var(--font-size-sm);
    color: #6b7280;
    margin-bottom: var(--space-16);
}

.browse-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-10) var(--space-20);
    background-color: #3b82f6;
    color: #ffffff;
    border: none;
    border-radius: var(--radius-base);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
}

.browse-button:hover {
    background-color: #2563eb;
}

.browse-button:active {
    background-color: #1d4ed8;
}

.file-input {
    display: none;
}

.file-list {
    margin-top: var(--space-24);
}

.file-list-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-16);
    color: #1f2937;
}

.file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-12) var(--space-16);
    background-color: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-base);
    margin-bottom: var(--space-8);
}

.file-info {
    display: flex;
    align-items: center;
    gap: var(--space-12);
    flex: 1;
}

.file-icon {
    font-size: var(--font-size-2xl);
}

.file-details {
    flex: 1;
}

.file-name {
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    color: #1f2937;
    margin-bottom: var(--space-2);
}

.file-size {
    font-size: var(--font-size-sm);
    color: #6b7280;
}

.remove-button {
    padding: var(--space-6) var(--space-12);
    background-color: transparent;
    color: #ef4444;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-sm);
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-standard);
}

.remove-button:hover {
    background-color: #fef2f2;
    border-color: #ef4444;
}

.action-buttons {
    display: flex;
    gap: var(--space-16);
    justify-content: center;
    margin-top: var(--space-24);
}

.process-button {
    padding: var(--space-12) var(--space-32);
    background-color: #3b82f6;
    color: #ffffff;
    border: none;
    border-radius: var(--radius-base);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
}

.process-button:hover:not(:disabled) {
    background-color: #2563eb;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.process-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.clear-button {
    padding: var(--space-12) var(--space-24);
    background-color: #ffffff;
    color: #374151;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-base);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
}

.clear-button:hover {
    background-color: #f3f4f6;
}

.processing-section {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-lg);
    padding: var(--space-32);
    text-align: center;
    margin-bottom: var(--space-24);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.processing-icon {
    font-size: 64px;
    margin-bottom: var(--space-16);
}

.processing-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    color: #1f2937;
    margin-bottom: var(--space-12);
}

.processing-text {
    font-size: var(--font-size-base);
    color: #6b7280;
    margin-bottom: var(--space-24);
}

.progress-bar {
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-bottom: var(--space-16);
}

.progress-fill {
    height: 100%;
    background-color: #3b82f6;
    transition: width var(--duration-normal) var(--ease-standard);
}

.step-list {
    text-align: left;
    max-width: 400px;
    margin: 0 auto;
}

.step-item {
    display: flex;
    align-items: center;
    gap: var(--space-12);
    padding: var(--space-8) 0;
    font-size: var(--font-size-base);
    color: #9ca3af;
}

.step-item.active {
    color: #3b82f6;
    font-weight: var(--font-weight-medium);
}

.step-item.completed {
    color: #10b981;
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #e5e7eb;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: #6b7280;
}

.step-item.active .step-number {
    background-color: #3b82f6;
    color: #ffffff;
}

.step-item.completed .step-number {
    background-color: #10b981;
    color: #ffffff;
}

.results-section {
    background-color: #ffffff;
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-lg);
    padding: var(--space-32);
    margin-bottom: var(--space-24);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.results-header {
    text-align: center;
    margin-bottom: var(--space-32);
}

.success-icon {
    font-size: 64px;
    margin-bottom: var(--space-16);
}

.results-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    color: #10b981;
    margin-bottom: var(--space-8);
}

.results-message {
    font-size: var(--font-size-base);
    color: #6b7280;
}

.results-iframe-container {
    width: 100%;
    min-height: 600px;
    margin-bottom: var(--space-32);
    border: 1px solid #e5e7eb;
    border-radius: var(--radius-lg);
    overflow: hidden;
    background-color: #ffffff;
}

.results-iframe {
    width: 100%;
    height: 600px;
    border: none;
    display: block;
}

.results-actions {
    display: flex;
    gap: var(--space-16);
    justify-content: center;
    flex-wrap: wrap;
}

.download-button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-8);
    padding: var(--space-12) var(--space-24);
    background-color: #3b82f6;
    color: #ffffff;
    border: none;
    border-radius: var(--radius-base);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
    text-decoration: none;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
}

.download-button:hover {
    background-color: #2563eb;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.new-batch-button {
    padding: var(--space-12) var(--space-24);
    background-color: #ffffff;
    color: #374151;
    border: 1px solid #d1d5db;
    border-radius: var(--radius-base);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
}

.new-batch-button:hover {
    background-color: #f3f4f6;
}

.alert {
    padding: var(--space-16);
    border-radius: var(--radius-base);
    margin-bottom: var(--space-24);
    display: flex;
    align-items: center;
    gap: var(--space-12);
    font-size: var(--font-size-base);
}

.alert-error {
    background-color: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.alert-icon {
    font-size: var(--font-size-xl);
}

.hidden {
    display: none !important;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.spin {
    animation: spin 1s linear infinite;
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-content {
        padding: var(--space-16);
    }

    .hero-title {
        font-size: var(--font-size-2xl);
    }

    .features-grid {
        grid-template-columns: 1fr;
    }

    .upload-section {
        padding: var(--space-16);
    }

    .drop-zone {
        padding: var(--space-24);
    }

    .action-buttons {
        flex-direction: column;
    }

    .results-actions {
        flex-direction: column;
    }
}
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üîÑ</span>
                    <span>Newmanator</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Hero Section -->
            <section class="hero-section">
                <h1 class="hero-title">Newman Report Collation Tool</h1>
                <p class="hero-description">Smart, one-command tool for collating Newman test reports into a single, interactive HTML summary</p>
            </section>

            <!-- Features Grid -->
            <div class="features-grid">
                <div class="feature-card">
                    <h3>‚ö° One-click automation</h3>
                    <p>Run once, collate everything</p>
                </div>
                <div class="feature-card">
                    <h3>üì¶ Multi-format support</h3>
                    <p>ZIP and HTML files supported</p>
                </div>
                <div class="feature-card">
                    <h3>üìä HTML summary output</h3>
                    <p>View results instantly in browser</p>
                </div>
                <div class="feature-card">
                    <h3>üß† Smart merge logic</h3>
                    <p>Combines multiple collections into unified summary</p>
                </div>
            </div>

            <!-- Upload Section -->
            <div id="uploadSection" class="upload-section">
                <div id="dropZone" class="drop-zone">
                    <div class="drop-zone-icon">üìÇ</div>
                    <div class="drop-zone-text">Drag &amp; drop your Newman reports here</div>
                    <div class="drop-zone-subtext">Supports .zip and .html files (up to 500MB per file)</div>
                    <button class="browse-button" id="browseButton">
                        Browse Files
                    </button>
                    <input type="file" id="fileInput" class="file-input" multiple accept=".zip,.html">
                </div>

                <div id="fileListContainer" class="file-list hidden">
                    <h3 class="file-list-title">Selected Files</h3>
                    <div id="fileList"></div>
                </div>

                <div id="actionButtons" class="action-buttons hidden">
                    <button class="process-button" onclick="processReports()">Process Reports</button>
                    <button class="clear-button" onclick="clearFiles()">Clear All</button>
                </div>
            </div>

            <!-- Error Alert -->
            <div id="errorAlert" class="alert alert-error hidden">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <span id="errorMessage"></span>
            </div>

            <!-- Processing Section -->
            <div id="processingSection" class="processing-section hidden">
                <div class="processing-icon spin">‚öôÔ∏è</div>
                <h2 class="processing-title">Processing Reports</h2>
                <p class="processing-text" id="processingStatus">Preparing your Newman reports...</p>
                
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>

                <div class="step-list">
                    <div class="step-item" id="step1">
                        <span class="step-number">1</span>
                        <span>File Validation</span>
                    </div>
                    <div class="step-item" id="step2">
                        <span class="step-number">2</span>
                        <span>Extraction/Processing</span>
                    </div>
                    <div class="step-item" id="step3">
                        <span class="step-number">3</span>
                        <span>Report Collation</span>
                    </div>
                    <div class="step-item" id="step4">
                        <span class="step-number">4</span>
                        <span>HTML Generation</span>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="results-section hidden">
                <div class="results-header">
                    <div class="success-icon">‚úÖ</div>
                    <h2 class="results-title">Reports Successfully Processed!</h2>
                    <p class="results-message">Your Newman reports have been collated into a unified summary</p>
                </div>

                <div class="results-iframe-container">
                    <iframe id="resultsIframe" class="results-iframe" sandbox="allow-same-origin allow-scripts"></iframe>
                </div>

                <div class="results-actions">
                    <a href="#" class="download-button" id="downloadLink" download="summary.html">
                        <span>üì•</span>
                        <span>Download Summary HTML</span>
                    </a>
                    <button class="new-batch-button" onclick="startNewBatch()">Process New Batch</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Application state
        let selectedFiles = [];
        let processingId = null;
        let eventSource = null;

        // Initialize event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Browse button - single event listener
            const browseButton = document.getElementById('browseButton');
            const fileInput = document.getElementById('fileInput');
            
            browseButton.addEventListener('click', () => {
                fileInput.click();
            });
            
            // File input change handler
            fileInput.addEventListener('change', (event) => {
                const files = Array.from(event.target.files);
                addFiles(files);
            });
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            addFiles(files);
        });

        // Add files to selection
        function addFiles(files) {
            const validFiles = files.filter(file => {
                const ext = file.name.toLowerCase();
                return ext.endsWith('.zip') || ext.endsWith('.html');
            });

            if (validFiles.length === 0) {
                showError('Please select valid .zip or .html files');
                return;
            }

            // Add to selected files
            validFiles.forEach(file => {
                if (!selectedFiles.some(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            });

            hideError();
            updateFileList();
        }

        // Update file list display
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileListContainer = document.getElementById('fileListContainer');
            const actionButtons = document.getElementById('actionButtons');

            if (selectedFiles.length === 0) {
                fileListContainer.classList.add('hidden');
                actionButtons.classList.add('hidden');
                return;
            }

            fileListContainer.classList.remove('hidden');
            actionButtons.classList.remove('hidden');

            fileList.innerHTML = selectedFiles.map((file, index) => {
                const icon = file.name.toLowerCase().endsWith('.zip') ? 'üì¶' : 'üìÑ';
                const size = formatFileSize(file.size);
                
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-icon">${icon}</div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${size}</div>
                            </div>
                        </div>
                        <button class="remove-button" onclick="removeFile(${index})">Remove</button>
                    </div>
                `;
            }).join('');
        }

        // Remove file from selection
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        // Clear all files
        function clearFiles() {
            selectedFiles = [];
            updateFileList();
            document.getElementById('fileInput').value = '';
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Show error message
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
        }

        // Hide error message
        function hideError() {
            document.getElementById('errorAlert').classList.add('hidden');
        }

        // Process reports
        async function processReports() {
            if (selectedFiles.length === 0) {
                showError('Please select at least one .zip or .html file to process');
                return;
            }

            try {
                // Hide upload section and error
                document.getElementById('uploadSection').classList.add('hidden');
                hideError();

                // Show processing section
                const processingSection = document.getElementById('processingSection');
                processingSection.classList.remove('hidden');

                // Upload files to backend
                const formData = new FormData();
                selectedFiles.forEach(file => {
                    formData.append('files', file);
                });

                console.log('Uploading files to backend...');
                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    const errorText = await uploadResponse.text();
                    console.error('Upload failed:', errorText);
                    throw new Error('Upload failed: ' + errorText);
                }

                const uploadData = await uploadResponse.json();
                console.log('Upload response:', uploadData);
                const sessionId = uploadData.sessionId || uploadData.id;
                processingId = sessionId;

                if (!sessionId) {
                    throw new Error('No session ID received from server');
                }

                // Connect to Server-Sent Events for real-time updates
                await connectToEventStream(sessionId);

                // Get the actual session ID after processing
                const actualSessionId = processingId;

                // Hide processing, show results
                processingSection.classList.add('hidden');
                await showResults(actualSessionId);

            } catch (error) {
                console.error('Processing error:', error);
                
                // Close event source if open
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                
                document.getElementById('processingSection').classList.add('hidden');
                document.getElementById('uploadSection').classList.remove('hidden');
                showError('Processing failed: ' + error.message + '. Check browser console for details.');
            }
        }

        // Connect to Server-Sent Events stream
        async function connectToEventStream(sessionId) {
            return new Promise((resolve, reject) => {
                console.log('Connecting to event stream:', `/api/events/${sessionId}`);
                
                eventSource = new EventSource(`/api/events/${sessionId}`);
                
                eventSource.onopen = () => {
                    console.log('Event stream connected');
                };

                eventSource.addEventListener('status', (event) => {
                    console.log('Status event received:', event.data);
                    try {
                        const status = JSON.parse(event.data);
                        updateProcessingUI(status);
                    } catch (error) {
                        console.error('Error parsing status:', error);
                    }
                });

                eventSource.addEventListener('complete', (event) => {
                    console.log('Complete event received:', event.data);
                    eventSource.close();
                    eventSource = null;
                    resolve();
                });

                eventSource.addEventListener('error-event', (event) => {
                    console.error('Error event received:', event.data);
                    const error = JSON.parse(event.data);
                    eventSource.close();
                    eventSource = null;
                    reject(new Error(error.message || 'Processing failed'));
                });

                eventSource.onerror = (error) => {
                    console.error('EventSource error:', error);
                    // Don't reject immediately - server might still be processing
                    // Fall back to polling if SSE fails
                    eventSource.close();
                    eventSource = null;
                    console.log('SSE failed, falling back to polling');
                    pollProcessingStatus(sessionId).then(resolve).catch(reject);
                };

                // Timeout after 5 minutes
                setTimeout(() => {
                    if (eventSource) {
                        eventSource.close();
                        eventSource = null;
                        reject(new Error('Processing timeout'));
                    }
                }, 300000);
            });
        }

        // Update processing UI based on status
        function updateProcessingUI(status) {
            const stepMapping = {
                'upload': { id: 'step1', message: 'Uploading files to server...', progress: 25 },
                'validation': { id: 'step1', message: 'Server validating files...', progress: 30 },
                'processing': { id: 'step2', message: 'Backend processing files...', progress: 50 },
                'collation': { id: 'step3', message: 'Backend collating reports...', progress: 75 },
                'complete': { id: 'step4', message: 'Comprehensive HTML generated!', progress: 100 }
            };

            const stage = status.stage || status.status || 'upload';
            const stepInfo = stepMapping[stage] || stepMapping['upload'];

            // Update status text
            const statusText = status.message || stepInfo.message;
            document.getElementById('processingStatus').textContent = statusText;
            
            // Update progress bar
            document.getElementById('progressFill').style.width = stepInfo.progress + '%';

            // Update step indicators
            const steps = ['step1', 'step2', 'step3', 'step4'];
            const currentStepIndex = parseInt(stepInfo.id.replace('step', '')) - 1;

            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                stepElement.classList.remove('active', 'completed');
                
                if (index < currentStepIndex) {
                    stepElement.classList.add('completed');
                } else if (index === currentStepIndex) {
                    stepElement.classList.add('active');
                }
            });
        }

        // Poll for processing status (fallback)
        async function pollProcessingStatus(id) {
            console.log('Polling status for:', id);
            
            while (true) {
                try {
                    const response = await fetch(`/api/status/${id}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Status check failed:', errorText);
                        throw new Error('Status check failed');
                    }

                    const status = await response.json();
                    console.log('Status:', status);
                    
                    if (status.error) {
                        throw new Error(status.error);
                    }

                    // Update UI
                    updateProcessingUI(status);

                    if (status.stage === 'complete' || status.status === 'complete') {
                        // Mark all steps as completed
                        ['step1', 'step2', 'step3', 'step4'].forEach(stepId => {
                            document.getElementById(stepId).classList.remove('active');
                            document.getElementById(stepId).classList.add('completed');
                        });
                        break;
                    }

                    // Poll every 1 second
                    await new Promise(resolve => setTimeout(resolve, 1000));

                } catch (error) {
                    console.error('Polling error:', error);
                    throw error;
                }
            }
        }

        // Show results
        async function showResults(id) {
            console.log('Fetching results for:', id);
            
            try {
                const response = await fetch(`/api/results/${id}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to fetch results:', errorText);
                    throw new Error('Failed to fetch results');
                }

                const results = await response.json();
                console.log('Results received:', results);
                
                // Display results section
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.classList.remove('hidden');

                // Display comprehensive HTML in iframe using srcdoc
                const iframe = document.getElementById('resultsIframe');
                if (results.html) {
                    iframe.srcdoc = results.html;
                    console.log('Comprehensive HTML displayed in iframe');
                } else {
                    console.warn('No HTML content in results');
                    iframe.srcdoc = '<html><body><p style="padding: 20px; text-align: center; color: #6b7280;">No HTML content available</p></body></html>';
                }

                // Set download link to actual summary file from backend
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.href = `/api/download/${id}`;
                downloadLink.download = 'summary.html';
                
                console.log('Download link set to:', downloadLink.href);

            } catch (error) {
                console.error('Results error:', error);
                // Show results section but still allow download
                const resultsSection = document.getElementById('resultsSection');
                resultsSection.classList.remove('hidden');
                
                // Show error in iframe
                const iframe = document.getElementById('resultsIframe');
                iframe.srcdoc = `<html><body><div style="padding: 40px; text-align: center;"><h2 style="color: #ef4444;">Error Loading Results</h2><p style="color: #6b7280;">${error.message}</p><p style="color: #9ca3af; font-size: 14px;">You can still try downloading the summary file below.</p></div></body></html>`;

                // Still provide download link - the file should exist even if HTML fetch failed
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.href = `/api/download/${id}`;
                downloadLink.download = 'summary.html';
                
                console.warn('Showing results with download link despite error');
            }
        }



        // Start new batch
        function startNewBatch() {
            // Close event source if still open
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            // Reset state
            selectedFiles = [];
            processingId = null;
            document.getElementById('fileInput').value = '';
            
            // Hide results and processing
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('processingSection').classList.add('hidden');
            
            // Reset processing steps
            ['step1', 'step2', 'step3', 'step4'].forEach(id => {
                document.getElementById(id).classList.remove('active', 'completed');
            });
            document.getElementById('progressFill').style.width = '0%';
            
            // Show upload section
            document.getElementById('uploadSection').classList.remove('hidden');
            updateFileList();
        }
    </script>
</body>
</html>